name: Cross-Repo Notify (Unified)

on:
  schedule:
    # Run every 8 hours
    - cron: '0 */8 * * *'
  workflow_dispatch:

jobs:
  notify-downstream:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history to analyze changes

      - name: Analyze workflow changes
        id: changes
        run: |
          # Find changes in .github/workflows/ from last 8 hours
          SINCE="8 hours ago"

          # Get commits that modified workflows
          COMMITS=$(git log --since="$SINCE" --pretty=format:"%H" -- .github/workflows/)

          if [ -z "$COMMITS" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No workflow changes in the last 8 hours"
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Get the oldest and newest commits
          OLDEST_COMMIT=$(echo "$COMMITS" | tail -1)
          NEWEST_COMMIT=$(echo "$COMMITS" | head -1)

          echo "oldest=$OLDEST_COMMIT" >> $GITHUB_OUTPUT
          echo "newest=$NEWEST_COMMIT" >> $GITHUB_OUTPUT

          # Generate unified diff of all workflow changes in this period
          # Compare: (parent of oldest commit)..newest commit
          PARENT_COMMIT="${OLDEST_COMMIT}^"

          {
            echo "=== UNIFIED DIFF OF ALL WORKFLOW CHANGES ==="
            echo "Time period: Last 8 hours"
            echo "From commit: $PARENT_COMMIT"
            echo "To commit: $NEWEST_COMMIT"
            echo ""
            echo "Files changed:"
            git diff --stat $PARENT_COMMIT..$NEWEST_COMMIT -- .github/workflows/
            echo ""
            echo "=== FULL DIFF ==="
            echo ""
            git diff $PARENT_COMMIT..$NEWEST_COMMIT -- .github/workflows/
          } > /tmp/unified-diff.txt

          # Also save commit list for reference
          {
            echo "=== COMMITS IN THIS PERIOD ==="
            for commit in $COMMITS; do
              echo "---"
              echo "Commit: $commit"
              echo "Subject: $(git log -1 --pretty=format:'%s' $commit)"
              echo "Author: $(git log -1 --pretty=format:'%an' $commit)"
              echo "Date: $(git log -1 --pretty=format:'%ai' $commit)"
              echo "Message:"
              git log -1 --pretty=format:'%B' $commit
              echo ""
            done
          } > /tmp/commits-list.txt
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Python
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.changes.outputs.has_changes == 'true'
        run: pip install anthropic

      - name: Analyze changes with Claude
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          chmod +x scripts/analyze-workflow-changes.py
          python scripts/analyze-workflow-changes.py unified /tmp/unified-diff.txt /tmp/changelog.md /tmp/commits-list.txt
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Create issue in issue-dump
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
        run: |
          TITLE="ðŸ”„ Workflow changes in jamiew/clactions ($(date -u '+%Y-%m-%d %H:%M UTC'))"

          # Build issue body with changelog + footer
          {
            cat /tmp/changelog.md
            echo ""
            echo "---"
            echo ""
            echo "@claude Please review these workflow changes and update any affected documentation, API clients, or downstream systems that may be impacted."
            echo ""
            echo "**Repository:** \`jamiew/clactions\`"
            echo "**Analysis method:** Unified diff (holistic AI analysis)"
            echo "**Period:** Last 8 hours"
            echo ""
            echo "**Quick Links:**"
            echo "- ðŸ“ [View workflow directory](https://github.com/jamiew/clactions/tree/main/.github/workflows)"
            echo "- ðŸ“ [Recent commits](https://github.com/jamiew/clactions/commits/main/.github/workflows)"
            echo "- ðŸ”— [Diff: ${{ steps.changes.outputs.oldest }}...${{ steps.changes.outputs.newest }}](https://github.com/jamiew/clactions/compare/${{ steps.changes.outputs.oldest }}...${{ steps.changes.outputs.newest }})"
            echo "- âš™ï¸ [This workflow run](https://github.com/jamiew/clactions/actions/runs/${{ github.run_id }})"
          } > /tmp/issue-body.md

          gh issue create \
            --repo jamiew/issue-dump \
            --title "$TITLE" \
            --body-file /tmp/issue-body.md
